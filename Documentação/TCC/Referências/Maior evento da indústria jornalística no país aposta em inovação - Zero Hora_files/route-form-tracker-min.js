!function(){var API_ENDPOINT="//form.routeapi.com",ROUTE_CDN_ENDPOINT="//www.routecdn.com/visualmode",ROUTE_EVENTS_ENDPOINT="https://app.route.to/forms/setup",Browser=window._rq.browser,Dom=window._rq.dom,Request=window._rq.request,Storage=window._rq.storage,String=window._rq.string,Utils=window._rq.utils,_=window._rq._,ENTER_KEYCODE=13,FORM_DISCOVERY_QUERYSTRING_KEY="__rtq_f_sc",FORM_DISCOVERY_BLOCK_QUERYSTRING_KEY="__rtq_f_scb",FORM_FIELD_VALUE_MAXLENGTH=1024,FORM_STATUS_ENABLED=1,FORM_TRACKS_STORE_KEY="_rtq_ft",FORM_VIEWED_FORMS_STORE_KEY="_rtq_fv",STORE_KEY=window._rq.STORE_KEY,Form={};(function(){var Metadata={};(function(){function a(a,b){var c=[];return _.each(a,function(a){for(var d=!1,e=0;!d&&e<b.length;e++){var f=b[e];d=a.uniqueId===f.uniqueId&&!f.isDeleted}!d&&c.push(a)}),c.length?(_.each(c,function(a){delete a.htmlElement}),void new Request({method:"POST",type:"XHR",url:String.format("{0}/?organizationId={1}",API_ENDPOINT,Utils.getOrganizationId()),data:JSON.stringify(c),contentType:"application/json",callback:function(a){if(a.error)throw new Error("[Route] Error saving forms.");return j()}})):j()}function b(b){var c=g();return c.length?void a(c,b):j()}function c(a){var b=location.pathname;"/"===b&&(b="homepage");var c=a.querySelector('input[type="submit"]')||a.querySelector('button[type="submit"]'),d="";if(c&&("BUTTON"===c.tagName?d=c.textContent.trim():"INPUT"===c.tagName&&(d=c.value.trim())),d)return"file:"===location.protocol?String.format('"{0}" form',d):String.format('"{0}" form on {1}',d,b);var e=(a.getAttribute("id")||a.getAttribute("name")||"").trim();return e?String.format("{0} form on {1}",e,b):String.format("Form on {0}",b)}function d(a){if(!a.fields||!a.fields.length)return"";var b=[];return _.each(a.fields,function(a){var c=a.element.attributes.name;-1===b.indexOf(c)&&b.push(c)}),b.join("=&")}function e(a){for(var b={},c=["id","name"],d=0;d<c.length;d++){var e=a.getAttribute(c[d]);if(e)return b[c[d]]=e,b}return b}function f(a){var b=Array.prototype.slice.call(a.querySelectorAll('input:not([type="button"]):not([type="file"]):not([type="hidden"]):not([type="password"]):not([type="reset"]):not([type="submit"]), select, textarea'));if(!b.length)return b;var c=[];return _.each(b,function(a){if(a.attributes.length){var b={element:{tagName:a.tagName.toLowerCase(),attributes:{}}},d=a.getAttribute("id");d&&(b.element.attributes.id=d);var e=a.getAttribute("name");if(e&&(b.element.attributes.name=e),"input"===b.element.tagName){var f=a.getAttribute("type");f&&(b.element.attributes.type=f)}(d||e)&&c.push(b)}}),c}function g(){var a=[],b=Array.prototype.slice.call(document.getElementsByTagName("form"));return b.length?(_.each(b,function(b){var g={fields:f(b)};if(g.fields.length&&(g.attributes=e(b),g.htmlElement=b,g.name=c(b),g.uniqueId=d(g),g.uniqueId)){if(a.length){for(var i=!1,j=0;!i&&j<a.length;j++)i=a[j].uniqueId===g.uniqueId;if(i)return}g.organizationId=Utils.getOrganizationId(),g.pages=[{title:document.title,url:h()}],a.push(g)}}),a):a}function h(){var a=location.host+location.pathname,b=a.indexOf(FORM_DISCOVERY_QUERYSTRING_KEY);return b>0&&(a=a.substring(0,b-1)),a.replace(location.protocol+"//","")}function i(a){new Request({method:"GET",type:"XHR",url:String.format("{0}/?organizationId={1}&url={2}",API_ENDPOINT,Utils.getOrganizationId(),String.escape(h())),callback:function(b){if(b.error)throw new Error("[Route] Error getting forms.");a.call(this,b.responseJSON)}})}function j(){var a=Utils.parseQueryString(location.href),b=a[FORM_DISCOVERY_BLOCK_QUERYSTRING_KEY];if(!b){var c=document.location.toString().substring(0,document.location.toString().indexOf("__rtq_f_sc")-1);return document.location=ROUTE_EVENTS_ENDPOINT+"?formUrl="+c}}function k(a){var c=Utils.parseQueryString(location.href),d=c[FORM_DISCOVERY_QUERYSTRING_KEY];d&&l(d,function(c){c&&(VisualMode.init(),b(a))})}function l(a,b){new Request({method:"POST",type:"XHR",url:String.format("{0}/validate?organizationId={1}",API_ENDPOINT,Utils.getOrganizationId()),data:JSON.stringify(a),contentType:"application/json",callback:function(a){if(a.error)throw new Error("[Route] Error validating Form Discovery Mode.");a.responseJSON&&b.call(this,a.responseJSON.success)}})}this.init=function(a){i(function(b){k(b),a.call(this,b)})}}).apply(Metadata);var VisualMode={};(function(){function a(b,c){var d=/\bposition:\s*fixed;/;if(b)for(var e=0;e<b.length;e++){var f=b[e];b.cssRules?a(b.cssRules,c):d.test(f.cssText)&&f.selectorText&&c.push(f.selectorText)}}function b(){for(var b=['[style*="position:fixed"],[style*="position: fixed"]'],c=document.styleSheets,d=[],e=0;e<c.length;e++)a(c[e].cssRules,b);b=b.join(",");for(var f=document.querySelectorAll(b),e=0;e<f.length;e++){var g=f[e];"fixed"===Dom.css(g,"position")&&d.push(g)}return d}function c(){var a=Dom.create("div",{className:"_route_header"}),b=Dom.create("div",{className:"_route_logo"}),c=Dom.create("img",{src:String.format("{0}/logo.png",ROUTE_CDN_ENDPOINT)});b.appendChild(c),a.appendChild(b);var d=Dom.create("div",{className:"_route_message",innerHTML:"Searching for forms..."});a.appendChild(d);var f=Dom.create("div",{className:"_route_message_feedback _route_message_success"});a.appendChild(f);var g=Dom.create("div",{className:"_route_event_wrapper"});g.appendChild(a),e.appendChild(Dom.create("link",{href:String.format("{0}/route-visualmode.css",ROUTE_CDN_ENDPOINT),rel:"stylesheet"})),e.appendChild(g)}function d(){var a=b();_.each(a,function(a){var b=Dom.offset(a).top;f>=b&&Dom.css(a,{top:f+"px"})})}var e,f=60;this.init=function(a){e=_.first(Dom.findByTagName("body")),Dom.addClass(e,"_route_wrapper"),d(),c()}}).apply(VisualMode);var Tracker={};(function(){function attachTracker(forms){function trackAndIdentify(a,b){var c={};_.each(a.fields,function(a){c=Utils.extendByDotNotation(c,a.routeAttribute,(a.htmlElements[b].value||"").substr(0,FORM_FIELD_VALUE_MAXLENGTH))});var d={boxId:a.boxId,formId:a.id,timestamp:Browser.timestamp()};Tracker.track(d),console.log("[Route] Form Tracking tracked a form."),_rq.push(["identify",c]),console.log("[Route] Form Tracking identified a contact.")}_.each(forms,function(form){if(!form.isDeleted&&form.status===FORM_STATUS_ENABLED){var htmlFormQuery="form";_.each(form.attributes,function(a,b){htmlFormQuery+=String.format('[{0}="{1}"]',b,a)});var htmlForms=Array.prototype.slice.call(document.querySelectorAll(htmlFormQuery));htmlForms.length&&_.each(htmlForms,function(htmlForm){var mappedFields=0,instanceId=Math.random().toString().substring(2),fields=[];if(_.each(form.fields,function(a){if(a.routeAttribute){mappedFields+=1;var b=a.element.tagName;_.each(a.element.attributes,function(a,c){b+=String.format('[{0}="{1}"]',c,a)});var c=htmlForm.querySelector(b);c&&(a.htmlElements=a.htmlElements||{},a.htmlElements[instanceId]=c,fields.push(a))}}),mappedFields===fields.length){form.fields=fields;for(var submitSelectors=['input[type="submit"]','button[type="submit"]','input[type="button"]',"button",'a:not([href^="http"]):not([href^="../"]):not([href^="/"])'],submitElements=[],i=0;!submitElements.length&&i<submitSelectors.length;i++)submitElements=Array.prototype.slice.call(htmlForm.querySelectorAll(submitSelectors[i]));if(submitElements.length){_.each(submitElements,function(submitElement){var onClick=submitElement.getAttribute("onclick");onClick&&!submitElement.removeAttribute("onclick")&&submitElement.setAttribute("data-original-onclick",onClick),submitElement.addEventListener("click",function(){trackAndIdentify(form,instanceId);var onClick=submitElement.getAttribute("data-original-onclick");onClick&&eval(onClick)})});var textElements=Array.prototype.slice.call(htmlForm.querySelectorAll('input[type="text"]'));_.each(textElements,function(textElement){var onKeyUp=textElement.getAttribute("onkeyup");onKeyUp&&!textElement.removeAttribute("onkeyup")&&textElement.setAttribute("data-original-onkeyup",onKeyUp),textElement.addEventListener("keyup",function(e){e.keyCode===ENTER_KEYCODE&&trackAndIdentify(form,instanceId);var onKeyUp=textElement.getAttribute("data-original-onkeyup");onKeyUp&&eval(onKeyUp)})}),Tracker.view(form)}}})}})}function startSyncingTracks(){!sync&&(sync=setInterval(syncLocalTracks,5e3))}function syncLocalTracks(){if(!isLocked&&_rq.isContactIdentified()){isLocked=!0;var a=new Storage(STORE_KEY),b=a.getObject(FORM_TRACKS_STORE_KEY)||[];if(!b.length)return void(isLocked=!1);var c=b.shift();a.setObject(FORM_TRACKS_STORE_KEY,b),isLocked=!1,c=_.extend(c,_rq.getIdentifiedContact()),new Request({method:"GET",type:"GIF",url:String.format("{0}/track",API_ENDPOINT),data:c})}}var isLocked=!1,sync;this.init=function(a){attachTracker(a),startSyncingTracks()},this.track=function(a){if(isLocked)return void setTimeout(function(){Tracker.track(a)},1e3);isLocked=!0;var b=new Storage(STORE_KEY),c=b.getLimitSize(),d=b.getObject(FORM_TRACKS_STORE_KEY)||[];d.push(a);for(var e=JSON.stringify(d);e.length>c;)d.shift(),e=JSON.stringify(d);b.set(FORM_TRACKS_STORE_KEY,e),isLocked=!1},this.view=function(a){var b=new Storage(STORE_KEY),c=b.getObject(FORM_VIEWED_FORMS_STORE_KEY)||[],d=_.contains(c,a.id);!d&&c.push(a.id)&&b.setObject(FORM_VIEWED_FORMS_STORE_KEY,c);var e={organizationId:a.organizationId,formId:a.id,unique:!d};new Request({method:"GET",type:"GIF",url:String.format("{0}/view",API_ENDPOINT),data:e})}}).apply(Tracker),this.init=function(){Metadata.init(Tracker.init)}}).apply(Form),Form.init()}();